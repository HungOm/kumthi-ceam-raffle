<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEAM Raffle - Ticket Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Oswald:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1A4B8C;
            --primary-dark: #0D3A6E;
            --primary-light: #2E6BB8;
            --ring-blue: #3B7DC9;
            --gold: #D4A84B;
            --gold-light: #E8C97D;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --purple: #8b5cf6;
            --bg-dark: #0a1628;
            --bg-card: #ffffff;
            --text-dark: #1a1a2e;
            --text-muted: #6b7280;
            --border: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #132744 50%, #1a4b8c 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ============ LOGIN SCREEN ============ */
        /* Password-protected login for admin access only */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0a1628 0%, #132744 50%, #1a4b8c 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto; /* Make overlay scrollable */
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-box {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh; /* Limit height to viewport */
            overflow-y: auto; /* Make box scrollable */
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            text-align: center;
            margin: auto; /* Center vertically when scrolling */
        }

        .login-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            border: 4px solid var(--primary);
            box-shadow: 0 8px 30px rgba(26,75,140,0.3);
        }

        .login-box h1 {
            font-family: 'Oswald', sans-serif;
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .login-box .subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 30px;
        }

        .login-form .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        /* Reduce spacing in setup form for better scrolling */
        #setupForm .form-group {
            margin-bottom: 12px;
        }
        
        #setupForm .form-group p {
            margin-top: 4px;
            margin-bottom: 0;
        }

        .login-form label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-form input {
            width: 100%;
            padding: 15px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26,75,140,0.15);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--ring-blue) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(26,75,140,0.4);
        }

        .login-error {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 15px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .remember-me input {
            width: auto;
        }

        .login-footer {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-muted);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--ring-blue) 100%);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .header h1 {
            font-family: 'Oswald', sans-serif;
            font-size: 28px;
            color: white;
            letter-spacing: 1px;
        }

        .header p {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card .icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-card .label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card.sold .value { color: var(--success); }
        .stat-card.reserved .value { color: var(--warning); }
        .stat-card.available .value { color: var(--ring-blue); }

        /* Main Panel */
        .main-panel {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        /* Controls */
        .controls {
            padding: 25px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26,75,140,0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--ring-blue) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26,75,140,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--gold) 0%, #c49a3d 100%);
            color: var(--primary-dark);
        }

        .btn-purple {
            background: linear-gradient(135deg, var(--purple) 0%, #7c3aed 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Status Badges */
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status.available {
            background: #dbeafe;
            color: var(--primary);
        }

        .status.sold {
            background: #d1fae5;
            color: #059669;
        }

        .status.reserved {
            background: #fef3c7;
            color: #d97706;
        }

        .status.donated {
            background: #fce7f3;
            color: #be185d;
        }

        /* Edit Form Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--ring-blue) 100%);
            padding: 20px 25px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-family: 'Oswald', sans-serif;
            letter-spacing: 1px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-footer {
            padding: 15px 25px 25px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }

        .file-upload .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .file-upload p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .file-upload input {
            display: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        /* Results Count */
        .results-info {
            padding: 15px 25px;
            background: #f0f9ff;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            color: var(--primary);
        }

        .results-info strong {
            color: var(--primary-dark);
        }

        /* Action Buttons in Table */
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.edit {
            background: #dbeafe;
            color: var(--primary);
        }

        .action-btn.edit:hover {
            background: var(--primary);
            color: white;
        }

        /* Sync Status Bar */
        .sync-status-bar {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            border-radius: 12px;
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(4, 120, 87, 0.3);
        }

        .sync-status-bar.syncing {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }

        .sync-status-bar.error {
            background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%);
        }

        .sync-status-bar.paused {
            background: linear-gradient(135deg, #92400e 0%, #d97706 100%);
        }

        .sync-status-bar.write-enabled {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .sync-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .sync-icon {
            font-size: 20px;
        }

        .sync-icon.spinning {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .sync-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sync-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sync-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .sync-btn.disconnect {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .sync-btn.disconnect:hover {
            background: rgba(239, 68, 68, 0.5);
        }

        /* Security Badge */
        .security-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 11px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.info { border-left: 4px solid var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ============ QUICK ACTIONS PANEL ============ */
        /* Easy buttons for non-tech admins to do common tasks */
        .quick-actions {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .quick-actions-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quick-actions-header h3 {
            font-size: 16px;
            color: var(--primary);
            margin: 0;
        }

        .help-tip {
            background: var(--primary);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            cursor: help;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .quick-btn {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 18px 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-family: 'Poppins', sans-serif;
        }

        .quick-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .quick-btn.sell {
            border-color: var(--success);
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .quick-btn.sell:hover {
            background: var(--success);
            color: white;
        }

        .quick-btn.find {
            border-color: var(--primary);
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .quick-btn.find:hover {
            background: var(--primary);
            color: white;
        }

        .quick-btn.reserve {
            border-color: var(--warning);
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .quick-btn.reserve:hover {
            background: var(--warning);
            color: white;
        }

        .quick-btn.report {
            border-color: var(--purple);
            background: linear-gradient(135deg, #faf5ff 0%, #ede9fe 100%);
        }

        .quick-btn.report:hover {
            background: var(--purple);
            color: white;
        }

        .quick-icon {
            display: block;
            font-size: 32px;
            margin-bottom: 8px;
        }

        .quick-label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            color: inherit;
        }

        .quick-desc {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .quick-btn:hover .quick-desc {
            color: rgba(255,255,255,0.8);
        }

        /* Quick Sell Modal */
        .quick-modal {
            background: white;
            border-radius: 20px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .quick-modal .modal-header {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .quick-modal.reserve .modal-header {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .quick-modal.report .modal-header {
            background: linear-gradient(135deg, var(--purple) 0%, #7c3aed 100%);
        }

        /* Report Summary */
        .report-summary {
            display: grid;
            gap: 15px;
        }

        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8fafc;
            border-radius: 10px;
        }

        .report-item .label {
            font-weight: 500;
            color: var(--text-dark);
        }

        .report-item .value {
            font-weight: 700;
            font-size: 18px;
            color: var(--primary);
        }

        .report-item.highlight {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .report-item.highlight .value {
            color: var(--success);
        }

        /* ============ NEW: Connection Status Messages ============ */
        .connection-msg {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .connection-msg.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .connection-msg.success {
            background: #f0fdf4;
            color: #059669;
            border: 1px solid #bbf7d0;
        }

        .connection-msg.info {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .connection-msg.warning {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .connection-steps {
            margin-top: 10px;
            padding-left: 20px;
        }

        .connection-steps li {
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .controls {
                flex-direction: column;
            }

            .control-group {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .login-box {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ============ ACCESS GATE ============ -->
    <!-- Google Account-based authentication - no passwords needed -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <img src="CEAM LOGO.png" alt="CEAM" class="login-logo" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%231A4B8C%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2230%22 font-family=%22Arial%22>C</text></svg>'">
            <h1>üîê CEAM Raffle Tracker</h1>
            <p class="subtitle">Access Control</p>
            
            <!-- Loading State -->
            <div id="loginLoading" style="display: block; padding: 30px 20px; text-align: center;">
                <div style="font-size: 32px; margin-bottom: 15px;">‚è≥</div>
                <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 10px;">Checking Google Account authorization...</p>
                <p style="color: var(--text-muted); font-size: 12px;">Please sign in with your Google account if prompted</p>
            </div>
            
            <!-- Authorized Access -->
            <div id="authorizedMessage" style="display: none; padding: 30px 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px; color: var(--success);">‚úÖ</div>
                <h2 style="color: var(--success); margin-bottom: 10px;">Access Granted</h2>
                <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;" id="authorizedUserInfo"></p>
                <button class="login-btn" onclick="proceedToDashboard()" style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%);">
                    üöÄ Enter Dashboard
                </button>
                <!-- Added reset link for testing different deployments -->
                <div style="margin-top: 15px;">
                    <a href="#" onclick="resetConnection(); return false;" style="color: var(--text-muted); font-size: 12px; text-decoration: none;">
                        üîå Try different deployment URL
                    </a>
                </div>
            </div>
            
            <!-- Unauthorized Access -->
            <div id="unauthorizedMessage" style="display: none; padding: 30px 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px; color: var(--danger);">‚ùå</div>
                <h2 style="color: var(--danger); margin-bottom: 10px;">Access Denied</h2>
                <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 15px;" id="unauthorizedDetails"></p>
                <div style="background: #fef3c7; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: left;">
                    <p style="margin: 0; font-size: 13px; color: #92400e;">
                        <strong>To get access:</strong><br>
                        1. Your Google account email must be in the Staff sheet<br>
                        2. Your account must be marked as Active<br>
                        3. Contact your administrator to add you
                    </p>
                </div>
                <!-- Added two-button layout for better UX: Check Again (retry current URL) and Reset Connection (try new URL) -->
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="checkAccessAgain()">
                        üîÑ Check Again
                    </button>
                    <button class="btn btn-outline" onclick="resetConnection()" style="background: var(--warning); color: white; border-color: var(--warning);">
                        üîå Try Different URL
                    </button>
                </div>
            </div>
            
            <!-- Connection Setup (First Time) -->
            <div id="connectionSetup" style="display: none; padding: 20px;">
                <div style="background: #dbeafe; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 13px; color: var(--primary);">
                        üîó <strong>First Time Setup</strong><br>
                        Enter your Google Apps Script Web App URL to connect.
                    </p>
                </div>
                <form onsubmit="setupConnection(event)" id="connectionSetupForm">
                    <div class="form-group">
                        <label>Apps Script Web App URL</label>
                        <input type="text" id="setupAppsScriptUrl" placeholder="https://script.google.com/macros/s/.../exec" required>
                        <p style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">From your Google Apps Script deployment</p>
                    </div>
                    <button type="submit" id="connectButton" class="login-btn" style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%); width: 100%;">
                        üîó Connect & Check Access
                    </button>
                </form>
                <div id="connectionStatus" style="display: none; margin-top: 15px; padding: 10px; border-radius: 8px; font-size: 13px;"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header with Logout Button -->
        <div class="header">
            <div class="header-left">
                <img src="CEAM LOGO.png" alt="CEAM" class="header-logo" onerror="this.style.display='none'">
                <div>
                    <h1>üéüÔ∏è CEAM Raffle Ticket Tracker</h1>
                    <p>Kumthi Charity Raffle 2026 ‚Ä¢ Staff-Verified Two-Way Sync</p>
                </div>
            </div>
            <div class="header-actions" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <!-- Current Staff Badge -->
                <div id="staffBadge" style="background: rgba(255,255,255,0.15); padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; color: white; font-size: 13px;">
                    <span>üë§</span>
                    <span id="currentStaffName">-</span>
                    <span id="userRoleBadge" style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 11px;"></span>
                </div>
                <button class="btn btn-warning" onclick="showStaffManagementModal()" title="Manage staff accounts (Admin only)" id="staffManagementBtn" style="display: none;">
                    üë• Manage Staff
                </button>
                <button class="btn btn-purple" onclick="showConnectModal()" title="Connect to Google Sheets for real-time sync">
                    üîó Connect Sheet
                </button>
                <button class="btn btn-gold" onclick="exportCSV()" title="Download all data as CSV file">
                    üì• Export CSV
                </button>
                <button class="btn btn-outline" onclick="logout()" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: white;" title="Log out of admin panel">
                    üö™ Logout
                </button>
            </div>
        </div>

        <!-- Sync Status Bar -->
        <div id="syncStatusBar" class="sync-status-bar" style="display: none;">
            <div class="sync-info">
                <span class="sync-icon" id="syncIcon">‚úÖ</span>
                <span id="syncText">Connected</span>
                <span class="security-badge" id="securityBadge">üîí Staff Verified</span>
            </div>
            <div class="sync-actions">
                <span id="lastSyncTime" style="font-size: 12px; opacity: 0.8;"></span>
                <button class="sync-btn" onclick="manualSync()">üîÑ Sync Now</button>
                <button class="sync-btn" onclick="toggleAutoSync()" id="autoSyncBtn">‚è∏Ô∏è Pause</button>
                <button class="sync-btn disconnect" onclick="disconnectSheet()">‚ùå Disconnect</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">üé´</div>
                <div class="value" id="totalTickets">0</div>
                <div class="label">Total Tickets</div>
            </div>
            <div class="stat-card sold">
                <div class="icon">‚úÖ</div>
                <div class="value" id="soldTickets">0</div>
                <div class="label">Sold</div>
            </div>
            <div class="stat-card reserved">
                <div class="icon">üìå</div>
                <div class="value" id="reservedTickets">0</div>
                <div class="label">Reserved</div>
            </div>
            <div class="stat-card available">
                <div class="icon">üéØ</div>
                <div class="value" id="availableTickets">0</div>
                <div class="label">Available</div>
            </div>
            <div class="stat-card">
                <div class="icon">üí∞</div>
                <div class="value" id="totalRevenue">RM 0</div>
                <div class="label">Revenue</div>
            </div>
        </div>

        <!-- ============ QUICK ACTIONS FOR NON-TECH ADMINS ============ -->
        <!-- Easy-to-use buttons for common tasks -->
        <div class="quick-actions" id="quickActionsPanel" style="display: none;">
            <div class="quick-actions-header">
                <h3>‚ö° Quick Actions</h3>
                <span class="help-tip" title="Click any button to perform common tasks quickly">‚ùì</span>
            </div>
            <div class="quick-actions-grid">
                <button class="quick-btn sell" onclick="quickSellTicket()">
                    <span class="quick-icon">üé´</span>
                    <span class="quick-label">Sell Ticket</span>
                    <span class="quick-desc">Mark ticket as sold</span>
                </button>
                <button class="quick-btn find" onclick="document.getElementById('searchInput').focus()">
                    <span class="quick-icon">üîç</span>
                    <span class="quick-label">Find Ticket</span>
                    <span class="quick-desc">Search by number or name</span>
                </button>
                <button class="quick-btn reserve" onclick="quickReserveTicket()">
                    <span class="quick-icon">üìå</span>
                    <span class="quick-label">Reserve Ticket</span>
                    <span class="quick-desc">Hold for customer</span>
                </button>
                <button class="quick-btn report" onclick="showQuickReport()">
                    <span class="quick-icon">üìä</span>
                    <span class="quick-label">View Report</span>
                    <span class="quick-desc">Sales summary</span>
                </button>
            </div>
        </div>

        <!-- Main Panel -->
        <div class="main-panel">
            <!-- File Upload -->
            <div class="controls" id="uploadSection">
                <div class="file-upload" onclick="document.getElementById('csvFile').click()">
                    <div class="icon">üìÅ</div>
                    <p><strong>Click to upload CSV</strong> or drag and drop</p>
                    <p style="font-size: 12px; margin-top: 5px;">ceam_raffle_tickets_tracking.csv</p>
                    <input type="file" id="csvFile" accept=".csv" onchange="loadCSV(event)">
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="loadDefaultData()">
                        üîÑ Load Default (6000 tickets)
                    </button>
                    <button class="btn btn-purple" onclick="showConnectModal()">
                        üìó Connect Google Sheet
                    </button>
                </div>
            </div>

            <!-- Search Controls (hidden until data loaded) -->
            <div class="controls" id="searchSection" style="display: none;">
                <div class="control-group">
                    <label>Search</label>
                    <input type="text" id="searchInput" placeholder="Ticket #, Name, Phone..." oninput="filterData()">
                </div>
                <div class="control-group" style="max-width: 180px;">
                    <label>Status</label>
                    <select id="statusFilter" onchange="filterData()">
                        <option value="">All Status</option>
                        <option value="Available">Available</option>
                        <option value="Sold">Sold</option>
                        <option value="Reserved">Reserved</option>
                        <option value="Donated">Donated</option>
                    </select>
                </div>
                <div class="control-group" style="max-width: 180px;">
                    <label>Book</label>
                    <select id="bookFilter" onchange="filterData()">
                        <option value="">All Books</option>
                    </select>
                </div>
                <div class="control-group" style="max-width: 180px;">
                    <label>Zone</label>
                    <select id="zoneFilter" onchange="filterData()">
                        <option value="">All Zones</option>
                    </select>
                </div>
                <button class="btn btn-outline" onclick="clearFilters()">
                    üîÑ Clear
                </button>
            </div>

            <!-- Results Info -->
            <div class="results-info" id="resultsInfo" style="display: none;">
                Showing <strong id="showingCount">0</strong> of <strong id="totalCount">0</strong> tickets
            </div>

            <!-- Table -->
            <div class="table-container" id="tableContainer">
                <div class="empty-state">
                    <div class="icon">üìä</div>
                    <h3>No Data Loaded</h3>
                    <p>Upload a CSV, connect Google Sheets, or load default data</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Ticket</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editIndex">
                <input type="hidden" id="editRowNum">
                <div class="form-group">
                    <label>Ticket Number</label>
                    <input type="text" id="editTicketNum" readonly style="background: #f3f4f6;">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editStatus">
                        <option value="Available">Available</option>
                        <option value="Sold">Sold</option>
                        <option value="Reserved">Reserved</option>
                        <option value="Donated">Donated</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Buyer Name</label>
                    <input type="text" id="editName" placeholder="Enter buyer name">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="editPhone" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label>Zone</label>
                    <input type="text" id="editZone" placeholder="Enter zone">
                </div>
                <div class="form-group">
                    <label>Sold By</label>
                    <input type="text" id="editSoldBy" placeholder="Seller name">
                </div>
                <div class="form-group">
                    <label>Payment Status</label>
                    <select id="editPayment">
                        <option value="">Not Paid</option>
                        <option value="Paid">Paid</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <input type="text" id="editNotes" placeholder="Additional notes">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveEdit()" id="saveEditBtn">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Quick Sell Modal - Complete form with all necessary fields -->
    <div class="modal-overlay" id="quickSellModal">
        <div class="quick-modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üé´ Quick Sell Ticket</h2>
                <button class="modal-close" onclick="closeQuickSellModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Row 1: Ticket Number -->
                <div class="form-group">
                    <label>üìã Ticket Number <span style="color: var(--danger);">*</span></label>
                    <input type="text" id="quickSellTicketNum" placeholder="e.g., CEAM-0001 or just 1" oninput="validateQuickTicket(this, 'sell')">
                    <p id="quickSellStatus" style="font-size: 12px; margin-top: 5px; color: var(--text-muted);"></p>
                </div>
                
                <!-- Row 2: Buyer Name & Phone (side by side) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>üë§ Buyer Name <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="quickSellName" placeholder="Full name" required>
                    </div>
                    <div class="form-group">
                        <label>üìû Phone Number <span style="color: var(--danger);">*</span></label>
                        <input type="tel" id="quickSellPhone" placeholder="e.g., 012-3456789" required>
                    </div>
                </div>
                
                <!-- Row 3: Zone & Payment (side by side) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>üìç Zone / Area</label>
                        <select id="quickSellZone">
                            <option value="">Select zone...</option>
                            <option value="KL">KL (Kuala Lumpur)</option>
                            <option value="Selangor">Selangor</option>
                            <option value="Penang">Penang</option>
                            <option value="Johor">Johor</option>
                            <option value="Perak">Perak</option>
                            <option value="Sabah">Sabah</option>
                            <option value="Sarawak">Sarawak</option>
                            <option value="Online">Online</option>
                            <option value="Event">Event/Booth</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üí≥ Payment Method</label>
                        <select id="quickSellPayment">
                            <option value="Cash">üíµ Cash</option>
                            <option value="Online Transfer">üì± Online Transfer</option>
                            <option value="QR Pay">üì≤ QR Pay (Touch n Go/GrabPay)</option>
                            <option value="Pending">‚è≥ Pending Payment</option>
                        </select>
                    </div>
                </div>
                
                <!-- Row 4: Seller Name (auto-filled with current staff) -->
                <!-- MODIFIED: Removed readonly attribute to allow editing of seller name -->
                <div class="form-group">
                    <label>üè∑Ô∏è Sold By</label>
                    <input type="text" id="quickSellSeller" placeholder="Who sold this ticket?">
                </div>
                
                <!-- Row 5: Notes -->
                <div class="form-group">
                    <label>üìù Notes (Optional)</label>
                    <input type="text" id="quickSellNotes" placeholder="Any special notes...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeQuickSellModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmQuickSell()" id="confirmSellBtn">
                    ‚úÖ Mark as Sold
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Reserve Modal -->
    <div class="modal-overlay" id="quickReserveModal">
        <div class="quick-modal reserve">
            <div class="modal-header">
                <h2>üìå Reserve Ticket</h2>
                <button class="modal-close" onclick="closeQuickReserveModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>üìã Ticket Number</label>
                    <input type="text" id="quickReserveTicketNum" placeholder="e.g., CEAM-0001 or just 1" oninput="validateQuickTicket(this, 'reserve')">
                    <p id="quickReserveStatus" style="font-size: 12px; margin-top: 5px; color: var(--text-muted);"></p>
                </div>
                <div class="form-group">
                    <label>üë§ Customer Name</label>
                    <input type="text" id="quickReserveName" placeholder="Who is this reserved for?">
                </div>
                <div class="form-group">
                    <label>üìû Phone Number</label>
                    <input type="text" id="quickReservePhone" placeholder="Contact number">
                </div>
                <div class="form-group">
                    <label>üìù Notes</label>
                    <input type="text" id="quickReserveNotes" placeholder="Any special notes">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeQuickReserveModal()">Cancel</button>
                <button class="btn btn-gold" onclick="confirmQuickReserve()" id="confirmReserveBtn">
                    üìå Reserve Ticket
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Report Modal -->
    <div class="modal-overlay" id="quickReportModal">
        <div class="quick-modal report">
            <div class="modal-header">
                <h2>üìä Sales Report</h2>
                <button class="modal-close" onclick="closeQuickReportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="report-summary" id="reportSummary">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeQuickReportModal()">Close</button>
                <button class="btn btn-purple" onclick="exportCSV()">üì• Export Full Report</button>
            </div>
        </div>
    </div>

    <!-- Connect Modal - Enhanced with Staff Validation -->
    <div class="modal-overlay" id="connectModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <h2>üîó Connect to Google Sheets</h2>
                <button class="modal-close" onclick="closeConnectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Current Staff Notice -->
                <div style="background: #eff6ff; border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid #bfdbfe;">
                    <p style="font-size: 13px; color: #1e40af; margin: 0;">
                        üë§ <strong>Connecting as:</strong> <span id="connectingAsStaff">-</span><br>
                        <span style="font-size: 11px; opacity: 0.8;">Your name must be in the "Staff" sheet to make changes.</span>
                    </p>
                </div>

                <!-- Connection Status Message - NEW: Enhanced error display -->
                <div id="connectionStatus" class="connection-msg" style="display: none;"></div>

                <!-- Apps Script URL -->
                <div class="form-group">
                    <label>Apps Script Web App URL</label>
                    <input type="text" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                    <p style="font-size: 11px; color: var(--text-muted); margin-top: 5px;">
                        No token needed - Google Account authentication is used automatically
                    </p>
                </div>

                <!-- Test & Connect Button -->
                <button class="btn btn-primary" onclick="testAndConnect()" id="testConnectBtn" style="width: 100%; margin-bottom: 20px;">
                    üîó Test Connection & Connect
                </button>

                <!-- Setup Guide -->
                <details style="background: #f8fafc; border-radius: 12px; padding: 15px;">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--primary);">üìñ Setup Guide</summary>
                    <div style="margin-top: 15px; font-size: 13px; line-height: 1.8;">
                        <p><strong>Your Google Sheet needs 2 tabs:</strong></p>
                        <ol style="padding-left: 20px; margin: 10px 0;">
                            <li><strong>"Tickets"</strong> (or Sheet1) - Your raffle ticket data</li>
                            <li><strong>"Staff"</strong> - List of authorized staff names in Column A</li>
                        </ol>
                        <p><strong>To deploy:</strong></p>
                        <ol style="padding-left: 20px;">
                            <li>Create a new Google Sheet for your raffle data</li>
                            <li>Go to <strong>Extensions ‚Üí Apps Script</strong></li>
                            <li>Delete existing code and paste the provided <strong>GoogleAppsScript_v2.gs</strong></li>
                            <li>Run <code>setupAll()</code> function to create headers & Staff sheet</li>
                            <li>Add staff emails to Staff sheet (Column A: Email, Column B: Name, Column C: Role, Column D: Active)</li>
                            <li>Click <strong>Deploy ‚Üí New deployment</strong></li>
                            <li>Type: <strong>Web app</strong></li>
                            <li>Execute as: <strong>Me</strong></li>
                            <li>Access: <strong>Anyone</strong></li>
                            <li>Click <strong>Deploy</strong> and copy the URL</li>
                            <li>Paste URL here and connect</li>
                        </ol>
                        <p style="margin-top: 10px; padding: 10px; background: #dbeafe; border-radius: 8px;">
                            <strong>üîê Security:</strong> Authentication uses your Google Account automatically. No passwords or tokens needed!
                        </p>
                    </div>
                </details>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeConnectModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Staff List Modal (Admin Only) -->
    <!-- Staff management is done directly in Google Sheets Staff tab -->
    <div class="modal-overlay" id="staffManagementModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h2>üë• Staff List</h2>
                <button class="modal-close" onclick="closeStaffManagementModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: #dbeafe; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 13px; color: var(--primary);">
                        <strong>üìù To add/remove staff:</strong><br>
                        Edit the Staff sheet in Google Sheets directly.<br>
                        Columns: Email | Name | Role | Active
                    </p>
                </div>

                <!-- Staff List -->
                <div>
                    <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-dark);">üìã Authorized Staff</h3>
                    <div id="staffList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeStaffManagementModal()">Close</button>
                <button class="btn btn-primary" onclick="refreshStaffList()">üîÑ Refresh</button>
            </div>
        </div>
    </div>

    <script>
        // ============ AUTHENTICATION CONFIG ============
        // Google Account-based authentication - no passwords needed
        // Uses Session.getActiveUser().getEmail() on server side

        // ============ DATA STATE ============
        let ticketData = [];
        let filteredData = [];
        const headers = [
            'Ticket_Number', 'Status', 'Sale_Type', 'Buyer_Name', 'Buyer_Phone',
            'Buyer_Zone', 'Sold_By', 'Payment_Status', 'Payment_Date', 'Book_Number',
            'Donated_To_Education', 'Notes', 'Modified_By', 'Modified_Date'
        ];
        
        // SECURITY FIX: HTML sanitization to prevent XSS attacks
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Current logged-in user info (from Google Account)
        let currentUserEmail = '';
        let currentStaffName = '';
        let currentUserRole = ''; // 'admin' or 'staff'
        let isLoggedIn = false;

        // ============ GOOGLE ACCOUNT AUTHENTICATION ============
        // Uses Google's built-in authentication - no passwords needed
        
        // Check if Google Sheets connection is available
        function hasConnection() {
            return syncConfig.appsScriptUrl !== null;
        }
        
        // Check if current user is admin
        function isAdmin() {
            return currentUserRole === 'admin';
        }

        // ============ SYNC STATE ============
        let syncConfig = {
            appsScriptUrl: null,
            autoSync: true,
            syncInterval: 30000, // 30 seconds
            lastSync: null
        };
        let syncIntervalId = null;
        let connectionVerified = false;
        let staffAuthorized = false; // Track if staff is in Staff sheet
        let isSyncing = false; // RACE CONDITION FIX: Prevent concurrent syncs

        // ============ ACCESS CONTROL FUNCTIONS ============
        // Google Account-based authentication - no passwords needed

        // Check Google Account access and authorization
        async function checkGoogleAccess() {
            if (!hasConnection()) {
                // Show connection setup
                document.getElementById('loginLoading').style.display = 'none';
                document.getElementById('authorizedMessage').style.display = 'none';
                document.getElementById('unauthorizedMessage').style.display = 'none';
                document.getElementById('connectionSetup').style.display = 'block';
                return;
            }
            
            try {
                // Check current user identity via Google Account
                const url = `${syncConfig.appsScriptUrl}?action=get_current_user`;
                const response = await fetch(url);
                const result = await response.json();
                
                // Detect if old script is still running (returns token errors)
                if (!result.success && (result.error && (result.error.includes('token') || result.error.includes('authentication token') || result.code === 'AUTH_ERROR'))) {
                    showUnauthorized('OLD_SCRIPT_DETECTED');
                    return;
                }
                
                if (result.success && result.user) {
                    // User is authorized
                    currentUserEmail = result.user.email;
                    currentStaffName = result.user.name;
                    currentUserRole = result.user.role;
                    isLoggedIn = true;
                    
                    // Check edit permissions
                    await checkStaffAuthorization();
                    
                    // Show authorized message
                    document.getElementById('loginLoading').style.display = 'none';
                    document.getElementById('unauthorizedMessage').style.display = 'none';
                    document.getElementById('connectionSetup').style.display = 'none';
                    document.getElementById('authorizedMessage').style.display = 'block';
                    
                    const roleText = currentUserRole === 'admin' ? 'üëë Admin' : 'üë§ Staff';
                    const accessText = staffAuthorized ? 'Full Access' : 'Read-Only';
                    document.getElementById('authorizedUserInfo').innerHTML = `
                        <strong>${escapeHtml(currentStaffName)}</strong><br>
                        ${escapeHtml(currentUserEmail)}<br>
                        ${roleText} ‚Ä¢ ${accessText}
                    `;
                } else {
                    // User not authorized
                    showUnauthorized(result.error || 'Your Google account is not authorized');
                }
            } catch (error) {
                console.error('Access check error:', error);
                showUnauthorized('Failed to verify access. Please try again.');
            }
        }
        
        // Show unauthorized message
        function showUnauthorized(reason) {
            document.getElementById('loginLoading').style.display = 'none';
            document.getElementById('authorizedMessage').style.display = 'none';
            document.getElementById('connectionSetup').style.display = 'none';
            document.getElementById('unauthorizedMessage').style.display = 'block';
            
            let details = 'Your Google account is not in the Staff sheet or is not active.';
            
            // Detect old script still running
            if (reason === 'OLD_SCRIPT_DETECTED' || (reason && reason.includes('token'))) {
                details = `
                    ‚ö†Ô∏è <strong>Old Apps Script Still Running</strong><br><br>
                    The error "Invalid or missing authentication token" means your Apps Script hasn't been updated yet.<br><br>
                    <strong>To fix:</strong><br>
                    1. Open your Google Sheet<br>
                    2. Go to <strong>Extensions ‚Üí Apps Script</strong><br>
                    3. Replace ALL code with the new <code>GoogleAppsScript_v2.gs</code><br>
                    4. Click <strong>Deploy ‚Üí Manage deployments</strong><br>
                    5. Click <strong>Edit</strong> (pencil icon)<br>
                    6. Click <strong>New version</strong> (IMPORTANT!)<br>
                    7. Click <strong>Deploy</strong><br>
                    8. Refresh this page and try again<br><br>
                    <small>See DEPLOYMENT_CHECKLIST.md for detailed instructions</small>
                `;
                document.getElementById('unauthorizedDetails').innerHTML = details;
                return;
            }
            
            if (reason && reason.includes('AUTH_REQUIRED')) {
                details = 'Please sign in with your Google account.';
            } else if (reason && reason.includes('UNAUTHORIZED')) {
                details = 'Your email is not in the Staff sheet. Contact your administrator.';
            } else if (reason) {
                details = reason;
            }
            
            document.getElementById('unauthorizedDetails').textContent = details;
        }
        
        // Setup connection (first time)
        async function setupConnection(event) {
            if (event) {
                event.preventDefault();
            }
            console.log('setupConnection called');
            
            const appsScriptUrl = document.getElementById('setupAppsScriptUrl').value.trim();
            const submitBtn = document.getElementById('connectButton');
            const statusDiv = document.getElementById('connectionStatus');
            
            if (!appsScriptUrl) {
                showToast('Please enter Apps Script URL', 'warning');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = 'var(--danger)';
                    statusDiv.textContent = '‚ùå Please enter Apps Script URL';
                }
                return;
            }
            
            // Show loading state
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '‚è≥ Connecting...';
            }
            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#dbeafe';
                statusDiv.style.color = 'var(--primary)';
                statusDiv.textContent = 'üîÑ Testing connection...';
            }
            
            // Test connection
            try {
                console.log('Testing connection to:', appsScriptUrl);
                
                // Remove /u/X/ from URL if present (multi-account issue)
                let cleanUrl = appsScriptUrl.replace(/\/u\/\d+\//g, '/');
                const url = `${cleanUrl}?action=ping`;
                console.log('Fetching (cleaned URL):', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                // Check if response is HTML (authorization page) instead of JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('text/html')) {
                    // This means Google is asking for authorization
                    console.log('Authorization required - user needs to authorize first');
                    if (statusDiv) {
                        statusDiv.style.background = '#fef3c7';
                        statusDiv.style.color = '#92400e';
                        statusDiv.innerHTML = `
                            ‚ö†Ô∏è <strong>Authorization Required</strong><br><br>
                            You need to authorize the Apps Script first.<br><br>
                            <strong>Steps:</strong><br>
                            1. Click the button below to open the authorization page<br>
                            2. Sign in with your Google account<br>
                            3. Click "Allow" or "Continue"<br>
                            4. Come back here and click "Connect" again<br><br>
                            <a href="${appsScriptUrl}?action=ping" target="_blank" 
                               style="display: inline-block; background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; margin-top: 10px;">
                                üîê Authorize Apps Script
                            </a>
                        `;
                    }
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'üîó Connect & Check Access';
                    }
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Response result:', result);
                
                if (result.success) {
                    console.log('Connection successful!');
                    if (statusDiv) {
                        statusDiv.style.background = '#d1fae5';
                        statusDiv.style.color = '#065f46';
                        statusDiv.textContent = '‚úÖ Connected! Checking access...';
                    }
                    
                    // Save connection
                    syncConfig.appsScriptUrl = appsScriptUrl;
                    localStorage.setItem('ceam_apps_script_url', appsScriptUrl);
                    connectionVerified = true;
                    
                    // Hide connection form, show loading
                    document.getElementById('connectionSetup').style.display = 'none';
                    document.getElementById('loginLoading').style.display = 'block';
                    
                    // Check access
                    await checkGoogleAccess();
                } else {
                    console.error('Connection failed:', result.error);
                    const errorMsg = result.error || 'Invalid URL';
                    const errorCode = result.code || '';
                    
                    // Special handling for AUTH_REQUIRED in public web apps
                    if (errorCode === 'AUTH_REQUIRED' || errorMsg.includes('authorize') || errorMsg.includes('sign in')) {
                        if (statusDiv) {
                            statusDiv.style.background = '#fef3c7';
                            statusDiv.style.color = '#92400e';
                            statusDiv.innerHTML = `
                                ‚ö†Ô∏è <strong>Authorization Required</strong><br><br>
                                For public web apps, you must authorize the script first.<br><br>
                                <strong>Steps:</strong><br>
                                1. Make sure you're signed in as <strong>hungom.oct19@gmail.com</strong><br>
                                2. Click the button below to authorize<br>
                                3. Click "Allow" or "Continue"<br>
                                4. Come back here and click "Connect" again<br><br>
                                <a href="${appsScriptUrl}?action=ping" target="_blank" 
                                   style="display: inline-block; background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; margin-top: 10px;">
                                    üîê Authorize Apps Script (Open in New Tab)
                                </a>
                            `;
                        }
                    } else {
                        showToast('Connection failed: ' + errorMsg, 'error');
                        if (statusDiv) {
                            statusDiv.style.background = '#fee2e2';
                            statusDiv.style.color = 'var(--danger)';
                            statusDiv.textContent = '‚ùå ' + errorMsg;
                        }
                    }
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'üîó Connect & Check Access';
                    }
                }
            } catch (error) {
                console.error('Connection error:', error);
                
                // Enhanced error handling for CORS and common issues
                // CORS errors typically indicate the Apps Script needs authorization or wrong deployment settings
                const isCorsError = error.message.includes('fetch') || error.message.includes('CORS') || error.message.includes('NetworkError');
                
                if (isCorsError) {
                    // CORS error - likely needs authorization or deployment settings fix
                    if (statusDiv) {
                        statusDiv.style.background = '#fef3c7';
                        statusDiv.style.color = '#92400e';
                        statusDiv.innerHTML = `
                            ‚ö†Ô∏è <strong>Connection Blocked (CORS Error)</strong><br><br>
                            This usually means one of the following:<br><br>
                            <div style="text-align: left; font-size: 12px; line-height: 1.6;">
                                <strong>1. Apps Script needs authorization:</strong><br>
                                ‚Ä¢ Click the button below to authorize the script<br>
                                ‚Ä¢ Sign in with your Google account<br>
                                ‚Ä¢ Click "Allow" when prompted<br>
                                ‚Ä¢ Come back and try connecting again<br><br>
                                
                                <strong>2. Deployment settings issue:</strong><br>
                                ‚Ä¢ Make sure "Execute as: Me" is selected<br>
                                ‚Ä¢ Make sure "Who has access: Anyone" is selected<br>
                                ‚Ä¢ Redeploy as a new version if needed<br><br>
                                
                                <strong>3. Testing from local server:</strong><br>
                                ‚Ä¢ CORS may block localhost (127.0.0.1)<br>
                                ‚Ä¢ Try opening the HTML file directly (file://)<br>
                                ‚Ä¢ Or deploy to a web server / GitHub Pages<br>
                            </div>
                            <br>
                            <a href="${appsScriptUrl}?action=ping" target="_blank" 
                               style="display: inline-block; background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; margin-top: 10px;">
                                üîê Try Authorizing Apps Script
                            </a>
                        `;
                    }
                    showToast('CORS error - Authorization may be needed. See details above.', 'error');
                } else {
                    // Other errors
                    const errorMsg = 'Connection error: ' + error.message;
                    showToast(errorMsg + '. Check browser console (F12) for details.', 'error');
                    if (statusDiv) {
                        statusDiv.style.background = '#fee2e2';
                        statusDiv.style.color = 'var(--danger)';
                        statusDiv.innerHTML = '‚ùå ' + error.message + '<br><small>Open browser console (F12) for details</small>';
                    }
                }
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'üîó Connect & Check Access';
                }
            }
        }
        
        // Proceed to dashboard
        function proceedToDashboard() {
            document.getElementById('loginOverlay').classList.add('hidden');
            updateStaffDisplay();
            updateReadOnlyIndicator();
            initializeUI();
            startAutoSync();
            showToast(`Welcome, ${currentStaffName}!`, 'success');
        }
        
        // Check access again
        function checkAccessAgain() {
            document.getElementById('loginLoading').style.display = 'block';
            document.getElementById('authorizedMessage').style.display = 'none';
            document.getElementById('unauthorizedMessage').style.display = 'none';
            document.getElementById('connectionSetup').style.display = 'none';
            checkGoogleAccess();
        }
        
        // Reset connection - allows user to try a different deployment URL
        // Clears saved URL from localStorage and shows the URL input screen
        function resetConnection() {
            if (confirm('üîÑ Reset Connection?\n\nThis will clear the current Google Apps Script URL and allow you to enter a new one.\n\nYou can use this to test a different deployment or switch to a new spreadsheet.')) {
                // Clear saved connection URL
                localStorage.removeItem('ceam_apps_script_url');
                localStorage.removeItem('ceam_admin_session');
                localStorage.removeItem('ceam_session_time');
                
                // Reset connection state
                syncConfig.appsScriptUrl = null;
                connectionVerified = false;
                isLoggedIn = false;
                staffAuthorized = false;
                
                // Hide all login screens
                document.getElementById('loginLoading').style.display = 'none';
                document.getElementById('authorizedMessage').style.display = 'none';
                document.getElementById('unauthorizedMessage').style.display = 'none';
                
                // Show connection setup screen to enter new URL
                document.getElementById('connectionSetup').style.display = 'block';
                
                // Clear the URL input field for fresh entry
                const urlInput = document.getElementById('setupAppsScriptUrl');
                if (urlInput) {
                    urlInput.value = '';
                    urlInput.focus();
                }
                
                showToast('Connection reset. Please enter a new URL.', 'info');
            }
        }
        
        // OLD FUNCTIONS REMOVED:
        // - setupPassword() - No longer needed (Google Account handles auth)
        // - attemptLogin() - No longer needed (Google Account handles auth)
        // - verifyUserLogin() - No longer needed
        // - All password hashing functions - No longer needed
        
        // Toggle password visibility
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.type = input.type === 'password' ? 'text' : 'password';
            }
        }
        
        // Update staff name display in header
        function updateStaffDisplay() {
            document.getElementById('currentStaffName').textContent = currentStaffName || '-';
            
            // Show role badge and admin-only features
            const roleBadge = document.getElementById('userRoleBadge');
            const staffManagementBtn = document.getElementById('staffManagementBtn');
            
            if (currentUserRole === 'admin') {
                roleBadge.textContent = 'üëë Admin';
                roleBadge.style.display = 'inline';
                if (staffManagementBtn) staffManagementBtn.style.display = 'inline-block';
            } else {
                roleBadge.textContent = '';
                roleBadge.style.display = 'none';
                if (staffManagementBtn) staffManagementBtn.style.display = 'none';
            }
            
            // Show read-only mode indicator if not authorized in Staff sheet
            updateReadOnlyIndicator();
        }
        
        // Update read-only mode indicator
        function updateReadOnlyIndicator() {
            // Remove existing indicator
            const existingIndicator = document.getElementById('readOnlyIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Add indicator if in read-only mode
            if (isLoggedIn && !staffAuthorized) {
                const header = document.querySelector('.header');
                if (header) {
                    const indicator = document.createElement('div');
                    indicator.id = 'readOnlyIndicator';
                    indicator.style.cssText = 'background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; padding: 10px 20px; text-align: center; font-size: 13px; font-weight: 600; border-bottom: 2px solid #fbbf24;';
                    indicator.innerHTML = '‚ö†Ô∏è READ-ONLY MODE - You can view tickets but cannot make changes. Contact admin to add your name to the Staff sheet for edit permissions.';
                    header.insertAdjacentElement('afterend', indicator);
                }
            }
            
            // Disable edit buttons if in read-only mode
            const editButtons = document.querySelectorAll('.action-btn.edit, .quick-btn.sell, .quick-btn.reserve');
            editButtons.forEach(btn => {
                if (!staffAuthorized && isLoggedIn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.title = 'Read-only mode - Contact admin for edit access';
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.title = '';
                }
            });
        }
        
        // Show password reset option
        function showResetOption(event) {
            event.preventDefault();
            if (confirm('‚ö†Ô∏è Reset password?\n\nThis will clear the current password and require you to set a new one.\n\nNote: You will need to re-enter Google Sheet connection details.')) {
                // Remove both old and new password storage formats
                localStorage.removeItem('ceam_admin_pw'); // Old base64 format
                localStorage.removeItem('ceam_admin_pw_hash'); // New SHA-256 format
                localStorage.removeItem('ceam_admin_session');
                localStorage.removeItem('ceam_session_time');
                location.reload();
            }
        }
        
        // Check Staff sheet authorization (for ticket edit permissions)
        // Uses Google Account identity - no username parameter needed
        async function checkStaffAuthorization() {
            if (!hasConnection() || !currentUserEmail) {
                staffAuthorized = false;
                return;
            }
            
            try {
                const url = `${syncConfig.appsScriptUrl}?action=validate_staff`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.isAuthorized) {
                    staffAuthorized = true;
                    // Update role if available
                    if (result.role) {
                        currentUserRole = result.role;
                    }
                } else {
                    staffAuthorized = false;
                }
            } catch (error) {
                console.error('Error checking staff authorization:', error);
                staffAuthorized = false;
            }
        }
        
        // Initialize access check on page load
        async function initAccessCheck() {
            // Show loading state
            document.getElementById('loginLoading').style.display = 'block';
            document.getElementById('authorizedMessage').style.display = 'none';
            document.getElementById('unauthorizedMessage').style.display = 'none';
            document.getElementById('connectionSetup').style.display = 'none';
            
            // Check if we have connection details
            const savedUrl = localStorage.getItem('ceam_apps_script_url');
            
            if (savedUrl) {
                syncConfig.appsScriptUrl = savedUrl;
                connectionVerified = true;
                
                // Check Google Account access
                await checkGoogleAccess();
            } else {
                // No connection - show setup
                document.getElementById('loginLoading').style.display = 'none';
                document.getElementById('connectionSetup').style.display = 'block';
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                isLoggedIn = false;
                currentUserEmail = '';
                currentStaffName = '';
                currentUserRole = '';
                staffAuthorized = false;
                
                // Clear session
                localStorage.removeItem('ceam_admin_session');
                localStorage.removeItem('ceam_session_time');
                
                // Show access gate again
                document.getElementById('loginOverlay').classList.remove('hidden');
                initAccessCheck();
                showToast('Logged out successfully', 'info');
            }
        }

        // Check if user is already logged in (Google Account session persists)
        async function checkSavedSession() {
            // Restore connection details
            const savedUrl = localStorage.getItem('ceam_apps_script_url');
            if (savedUrl) {
                syncConfig.appsScriptUrl = savedUrl;
                connectionVerified = true;
                
                // Check if we have a valid session
                const session = localStorage.getItem('ceam_admin_session');
                if (session === 'active' && hasConnection()) {
                    // Verify access is still valid
                    try {
                        const url = `${syncConfig.appsScriptUrl}?action=get_current_user`;
                        const response = await fetch(url);
                        const result = await response.json();
                        
                        if (result.success && result.user) {
                            // Session still valid
                            currentUserEmail = result.user.email;
                            currentStaffName = result.user.name;
                            currentUserRole = result.user.role;
                            isLoggedIn = true;
                            
                            await checkStaffAuthorization();
                            
                            document.getElementById('loginOverlay').classList.add('hidden');
                            updateStaffDisplay();
                            updateReadOnlyIndicator();
                            initializeUI();
                            startAutoSync();
                            return true;
                        }
                    } catch (error) {
                        console.error('Session check failed:', error);
                    }
                }
            }
            return false;
        }

        // Refresh session timestamp (extends session on activity)
        function refreshSession() {
            if (isLoggedIn) {
                localStorage.setItem('ceam_session_time', Date.now().toString());
            }
        }

        // Clear all session data
        function clearSession() {
            localStorage.removeItem('ceam_admin_session');
            localStorage.removeItem('ceam_session_time');
            localStorage.removeItem('ceam_remember_me');
        }

        // Track user activity to keep session alive
        function startSessionTracker() {
            // Refresh session every 5 minutes while active
            setInterval(() => {
                if (isLoggedIn) {
                    refreshSession();
                }
            }, 300000); // 5 minutes

            // Refresh session on user activity
            ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
                document.addEventListener(event, debounce(refreshSession, 60000), { passive: true });
            });
        }

        // Debounce function to limit refresh calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ============ QUICK ACTION FUNCTIONS ============
        // Easy-to-use functions for non-tech admins
        function quickSellTicket() {
            if (ticketData.length === 0) {
                showToast('Please load data first!', 'warning');
                return;
            }
            document.getElementById('quickSellModal').classList.add('active');
            document.getElementById('quickSellTicketNum').value = '';
            document.getElementById('quickSellName').value = '';
            document.getElementById('quickSellPhone').value = '';
            document.getElementById('quickSellZone').value = '';
            document.getElementById('quickSellPayment').value = 'Cash';
            // MODIFIED: Removed auto-fill of seller name - tickets may be sold by someone else
            document.getElementById('quickSellSeller').value = '';
            document.getElementById('quickSellNotes').value = '';
            document.getElementById('quickSellStatus').textContent = '';
            document.getElementById('quickSellTicketNum').focus();
        }

        function closeQuickSellModal() {
            document.getElementById('quickSellModal').classList.remove('active');
        }

        function quickReserveTicket() {
            if (ticketData.length === 0) {
                showToast('Please load data first!', 'warning');
                return;
            }
            document.getElementById('quickReserveModal').classList.add('active');
            document.getElementById('quickReserveTicketNum').value = '';
            document.getElementById('quickReserveName').value = '';
            document.getElementById('quickReservePhone').value = '';
            document.getElementById('quickReserveNotes').value = '';
            document.getElementById('quickReserveStatus').textContent = '';
            document.getElementById('quickReserveTicketNum').focus();
        }

        function closeQuickReserveModal() {
            document.getElementById('quickReserveModal').classList.remove('active');
        }

        function validateQuickTicket(input, type) {
            let ticketNum = input.value.trim().toUpperCase();
            
            // Auto-format: if just a number, add CEAM- prefix
            if (/^\d+$/.test(ticketNum)) {
                ticketNum = 'CEAM-' + ticketNum.padStart(4, '0');
            }
            
            const statusEl = document.getElementById(type === 'sell' ? 'quickSellStatus' : 'quickReserveStatus');
            const ticket = ticketData.find(t => t.Ticket_Number === ticketNum);
            
            if (ticket) {
                if (ticket.Status === 'Available') {
                    statusEl.innerHTML = `<span style="color: var(--success);">‚úÖ Ticket found: ${ticketNum} - Available</span>`;
                } else {
                    statusEl.innerHTML = `<span style="color: var(--warning);">‚ö†Ô∏è Ticket ${ticketNum} is already ${ticket.Status}</span>`;
                }
            } else if (ticketNum.length > 3) {
                statusEl.innerHTML = `<span style="color: var(--danger);">‚ùå Ticket not found</span>`;
            } else {
                statusEl.textContent = '';
            }
        }

        async function confirmQuickSell() {
            let ticketNum = document.getElementById('quickSellTicketNum').value.trim().toUpperCase();
            const buyerName = document.getElementById('quickSellName').value.trim();
            const phone = document.getElementById('quickSellPhone').value.trim();
            const zone = document.getElementById('quickSellZone').value;
            const paymentMethod = document.getElementById('quickSellPayment').value;
            // MODIFIED: Get soldBy from input field instead of always using currentStaffName
            const soldBy = document.getElementById('quickSellSeller').value.trim();
            const notes = document.getElementById('quickSellNotes').value.trim();

            // Auto-format ticket number
            if (/^\d+$/.test(ticketNum)) {
                ticketNum = 'CEAM-' + ticketNum.padStart(4, '0');
            }

            // Validation
            if (!ticketNum) {
                showToast('Please enter a ticket number', 'warning');
                document.getElementById('quickSellTicketNum').focus();
                return;
            }
            
            if (!buyerName) {
                showToast('Please enter buyer name', 'warning');
                document.getElementById('quickSellName').focus();
                return;
            }
            
            if (!phone) {
                showToast('Please enter phone number', 'warning');
                document.getElementById('quickSellPhone').focus();
                return;
            }

            // MODIFIED: Added validation for soldBy field
            if (!soldBy) {
                showToast('Please enter who sold this ticket', 'warning');
                document.getElementById('quickSellSeller').focus();
                return;
            }

            const ticketIndex = ticketData.findIndex(t => t.Ticket_Number === ticketNum);
            
            if (ticketIndex === -1) {
                showToast('Ticket not found!', 'error');
                return;
            }

            const ticket = ticketData[ticketIndex];
            
            if (ticket.Status !== 'Available' && ticket.Status !== 'Reserved') {
                if (!confirm(`This ticket is already ${ticket.Status}. Update anyway?`)) {
                    return;
                }
            }

            // MODIFIED: Disable button and show loading during submission
            const btn = document.getElementById('confirmSellBtn');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Saving...';

            // Update ticket data with all fields
            ticketData[ticketIndex].Status = 'Sold';
            ticketData[ticketIndex].Sale_Type = paymentMethod;
            ticketData[ticketIndex].Buyer_Name = buyerName;
            ticketData[ticketIndex].Buyer_Phone = phone;
            ticketData[ticketIndex].Buyer_Zone = zone;
            // MODIFIED: Use soldBy from input field instead of currentStaffName
            ticketData[ticketIndex].Sold_By = soldBy;
            ticketData[ticketIndex].Payment_Status = paymentMethod === 'Pending' ? 'Pending' : 'Paid';
            ticketData[ticketIndex].Payment_Date = new Date().toISOString().split('T')[0];
            ticketData[ticketIndex].Notes = notes;
            // Track who made this change (still track who submitted the change)
            ticketData[ticketIndex].Modified_By = currentStaffName;
            ticketData[ticketIndex].Modified_Date = new Date().toISOString();

            // Sync to Google Sheets if connected
            if (connectionVerified && staffAuthorized && ticket._rowNum) {
                await syncTicketToSheet(ticketIndex);
            }

            // MODIFIED: Re-enable button after submission
            btn.disabled = false;
            btn.innerHTML = originalBtnText;

            closeQuickSellModal();
            updateStats();
            filterData();
            showToast(`üéâ Ticket ${ticketNum} sold to ${buyerName} by ${soldBy}!`, 'success');
        }

        async function confirmQuickReserve() {
            let ticketNum = document.getElementById('quickReserveTicketNum').value.trim().toUpperCase();
            const customerName = document.getElementById('quickReserveName').value.trim();
            const phone = document.getElementById('quickReservePhone').value.trim();
            const notes = document.getElementById('quickReserveNotes').value.trim();

            // Auto-format ticket number
            if (/^\d+$/.test(ticketNum)) {
                ticketNum = 'CEAM-' + ticketNum.padStart(4, '0');
            }

            if (!ticketNum) {
                showToast('Please enter a ticket number', 'warning');
                return;
            }

            const ticketIndex = ticketData.findIndex(t => t.Ticket_Number === ticketNum);
            
            if (ticketIndex === -1) {
                showToast('Ticket not found!', 'error');
                return;
            }

            const ticket = ticketData[ticketIndex];
            
            if (ticket.Status !== 'Available') {
                if (!confirm(`This ticket is ${ticket.Status}. Reserve anyway?`)) {
                    return;
                }
            }

            // MODIFIED: Disable button and show loading during submission
            const btn = document.getElementById('confirmReserveBtn');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Saving...';

            // Update ticket data
            ticketData[ticketIndex].Status = 'Reserved';
            ticketData[ticketIndex].Buyer_Name = customerName;
            ticketData[ticketIndex].Buyer_Phone = phone;
            ticketData[ticketIndex].Notes = notes;
            // Track who made this change
            ticketData[ticketIndex].Modified_By = currentStaffName;
            ticketData[ticketIndex].Modified_Date = new Date().toISOString();

            // Sync to Google Sheets if connected
            if (connectionVerified && staffAuthorized && ticket._rowNum) {
                await syncTicketToSheet(ticketIndex);
            }

            // MODIFIED: Re-enable button after submission
            btn.disabled = false;
            btn.innerHTML = originalBtnText;

            closeQuickReserveModal();
            updateStats();
            filterData();
            showToast(`üìå Ticket ${ticketNum} reserved for ${customerName || 'customer'} by ${currentStaffName}!`, 'success');
        }

        // NEW: Enhanced sync function that includes staff name for server-side validation
        async function syncTicketToSheet(index) {
            const ticket = ticketData[index];
            try {
                const values = [
                    ticket.Ticket_Number,
                    ticket.Status,
                    ticket.Sale_Type || '',
                    ticket.Buyer_Name || '',
                    ticket.Buyer_Phone || '',
                    ticket.Buyer_Zone || '',
                    ticket.Sold_By || '',
                    ticket.Payment_Status || '',
                    ticket.Payment_Date || '',
                    ticket.Book_Number || '',
                    ticket.Donated_To_Education || '',
                    ticket.Notes || ''
                ];

                // Google Account authentication happens automatically on server
                const url = `${syncConfig.appsScriptUrl}?action=update&row=${ticket._rowNum}&values=${encodeURIComponent(JSON.stringify(values))}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (!result.success) {
                    if (result.code === 'STAFF_UNAUTHORIZED') {
                        showToast(`‚ö†Ô∏è Staff "${currentStaffName}" is not authorized. Changes saved locally only.`, 'warning');
                        staffAuthorized = false;
                    } else {
                        showToast('Sync error: ' + result.error, 'warning');
                    }
                }
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Sync error: ' + error.message, 'warning');
            }
        }

        function showQuickReport() {
            if (ticketData.length === 0) {
                showToast('Please load data first!', 'warning');
                return;
            }

            const total = ticketData.length;
            const sold = ticketData.filter(t => t.Status === 'Sold').length;
            const reserved = ticketData.filter(t => t.Status === 'Reserved').length;
            const available = ticketData.filter(t => t.Status === 'Available').length;
            const donated = ticketData.filter(t => t.Status === 'Donated').length;
            const revenue = sold * 10;
            const potentialRevenue = total * 10;
            const soldPercent = total > 0 ? ((sold / total) * 100).toFixed(1) : 0;

            // NEW: Count modifications by staff
            const byStaff = {};
            ticketData.filter(t => t.Modified_By).forEach(t => {
                byStaff[t.Modified_By] = (byStaff[t.Modified_By] || 0) + 1;
            });
            
            let staffReport = Object.entries(byStaff)
                .sort((a, b) => b[1] - a[1])
                .map(([name, count]) => `
                    <div class="report-item">
                        <span class="label">üë§ ${escapeHtml(name)}</span>
                        <span class="value">${count}</span>
                    </div>
                `).join('');

            document.getElementById('reportSummary').innerHTML = `
                <div class="report-item highlight">
                    <span class="label">üí∞ Total Revenue</span>
                    <span class="value">RM ${revenue.toLocaleString()}</span>
                </div>
                <div class="report-item">
                    <span class="label">üé´ Total Tickets</span>
                    <span class="value">${total.toLocaleString()}</span>
                </div>
                <div class="report-item">
                    <span class="label">‚úÖ Sold</span>
                    <span class="value">${sold.toLocaleString()} (${soldPercent}%)</span>
                </div>
                <div class="report-item">
                    <span class="label">üìå Reserved</span>
                    <span class="value">${reserved.toLocaleString()}</span>
                </div>
                <div class="report-item">
                    <span class="label">üéØ Available</span>
                    <span class="value">${available.toLocaleString()}</span>
                </div>
                <div class="report-item">
                    <span class="label">üéÅ Donated</span>
                    <span class="value">${donated.toLocaleString()}</span>
                </div>
                <div class="report-item" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                    <span class="label">üìà Potential Total</span>
                    <span class="value">RM ${potentialRevenue.toLocaleString()}</span>
                </div>
                ${staffReport ? `
                    <hr style="border: none; border-top: 1px solid var(--border); margin: 10px 0;">
                    <h4 style="font-size: 13px; color: var(--primary); margin-bottom: 10px;">üìù Modifications by Staff</h4>
                    ${staffReport}
                ` : ''}
            `;

            document.getElementById('quickReportModal').classList.add('active');
        }

        function closeQuickReportModal() {
            document.getElementById('quickReportModal').classList.remove('active');
        }

        // ============ TOAST NOTIFICATIONS ============
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            toast.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ============ CSV HANDLING ============
        function loadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
                showToast('CSV loaded successfully!', 'success');
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            ticketData = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 2) {
                    ticketData.push({
                        Ticket_Number: values[0] || '',
                        Status: values[1] || 'Available',
                        Sale_Type: values[2] || '',
                        Buyer_Name: values[3] || '',
                        Buyer_Phone: values[4] || '',
                        Buyer_Zone: values[5] || '',
                        Sold_By: values[6] || '',
                        Payment_Status: values[7] || '',
                        Payment_Date: values[8] || '',
                        Book_Number: values[9] || '',
                        Donated_To_Education: values[10] || '',
                        Notes: values[11] || '',
                        Modified_By: values[12] || '',
                        Modified_Date: values[13] || '',
                        _rowNum: i + 1
                    });
                }
            }

            initializeUI();
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            return values;
        }

        function loadDefaultData() {
            ticketData = [];
            for (let i = 1; i <= 6000; i++) {
                const ticketNum = 'CEAM-' + String(i).padStart(4, '0');
                const bookNum = 'Book-' + String(Math.ceil(i / 10)).padStart(4, '0');
                ticketData.push({
                    Ticket_Number: ticketNum,
                    Status: 'Available',
                    Sale_Type: '',
                    Buyer_Name: '',
                    Buyer_Phone: '',
                    Buyer_Zone: '',
                    Sold_By: '',
                    Payment_Status: '',
                    Payment_Date: '',
                    Book_Number: bookNum,
                    Donated_To_Education: '',
                    Notes: '',
                    Modified_By: '',
                    Modified_Date: '',
                    _rowNum: i + 1
                });
            }
            initializeUI();
            showToast('Loaded 6000 default tickets', 'success');
        }

        // ============ UI INITIALIZATION ============
        function initializeUI() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('searchSection').style.display = 'flex';
            document.getElementById('resultsInfo').style.display = 'block';
            document.getElementById('quickActionsPanel').style.display = 'block'; // Show quick actions for admins

            // Populate book filter
            const books = [...new Set(ticketData.map(t => t.Book_Number))].filter(b => b);
            const bookSelect = document.getElementById('bookFilter');
            bookSelect.innerHTML = '<option value="">All Books</option>';
            books.slice(0, 100).forEach(book => {
                bookSelect.innerHTML += `<option value="${book}">${book}</option>`;
            });

            // Populate zone filter
            const zones = [...new Set(ticketData.map(t => t.Buyer_Zone))].filter(z => z);
            const zoneSelect = document.getElementById('zoneFilter');
            zoneSelect.innerHTML = '<option value="">All Zones</option>';
            zones.forEach(zone => {
                zoneSelect.innerHTML += `<option value="${zone}">${zone}</option>`;
            });

            filteredData = [...ticketData];
            updateStats();
            renderTable();
        }

        // ============ STATISTICS ============
        function updateStats() {
            const total = ticketData.length;
            const sold = ticketData.filter(t => t.Status === 'Sold').length;
            const reserved = ticketData.filter(t => t.Status === 'Reserved').length;
            const available = ticketData.filter(t => t.Status === 'Available').length;
            const revenue = sold * 10;

            document.getElementById('totalTickets').textContent = total.toLocaleString();
            document.getElementById('soldTickets').textContent = sold.toLocaleString();
            document.getElementById('reservedTickets').textContent = reserved.toLocaleString();
            document.getElementById('availableTickets').textContent = available.toLocaleString();
            document.getElementById('totalRevenue').textContent = 'RM ' + revenue.toLocaleString();
        }

        // ============ FILTERING ============
        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const book = document.getElementById('bookFilter').value;
            const zone = document.getElementById('zoneFilter').value;

            filteredData = ticketData.filter(ticket => {
                const matchSearch = !search || 
                    ticket.Ticket_Number.toLowerCase().includes(search) ||
                    (ticket.Buyer_Name || '').toLowerCase().includes(search) ||
                    (ticket.Buyer_Phone || '').toLowerCase().includes(search) ||
                    (ticket.Sold_By || '').toLowerCase().includes(search) ||
                    (ticket.Modified_By || '').toLowerCase().includes(search);
                
                const matchStatus = !status || ticket.Status === status;
                const matchBook = !book || ticket.Book_Number === book;
                const matchZone = !zone || ticket.Buyer_Zone === zone;

                return matchSearch && matchStatus && matchBook && matchZone;
            });

            renderTable();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('bookFilter').value = '';
            document.getElementById('zoneFilter').value = '';
            filteredData = [...ticketData];
            renderTable();
        }

        // ============ TABLE RENDERING ============
        function renderTable() {
            const container = document.getElementById('tableContainer');
            document.getElementById('showingCount').textContent = filteredData.length.toLocaleString();
            document.getElementById('totalCount').textContent = ticketData.length.toLocaleString();

            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <h3>No Results Found</h3>
                        <p>Try adjusting your search or filters</p>
                    </div>
                `;
                return;
            }

            const displayData = filteredData.slice(0, 500);

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Ticket #</th>
                            <th>Status</th>
                            <th>Buyer Name</th>
                            <th>Phone</th>
                            <th>Zone</th>
                            <th>Sold By</th>
                            <th>Payment</th>
                            <th>Book</th>
                            <th>Modified By</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            displayData.forEach((ticket, index) => {
                const statusClass = escapeHtml(ticket.Status).toLowerCase();
                // INDEX CORRUPTION FIX: Use ticket number as ID instead of array index
                const ticketId = escapeHtml(ticket.Ticket_Number);
                // SECURITY FIX: Sanitize all user-provided data to prevent XSS attacks
                html += `
                    <tr>
                        <td><strong>${ticketId}</strong></td>
                        <td><span class="status ${statusClass}">${escapeHtml(ticket.Status)}</span></td>
                        <td>${escapeHtml(ticket.Buyer_Name) || '-'}</td>
                        <td>${escapeHtml(ticket.Buyer_Phone) || '-'}</td>
                        <td>${escapeHtml(ticket.Buyer_Zone) || '-'}</td>
                        <td>${escapeHtml(ticket.Sold_By) || '-'}</td>
                        <td>${escapeHtml(ticket.Payment_Status) || '-'}</td>
                        <td>${escapeHtml(ticket.Book_Number)}</td>
                        <td style="font-size: 11px; color: var(--text-muted);">${escapeHtml(ticket.Modified_By) || '-'}</td>
                        <td><button class="action-btn edit" onclick="editTicketById('${ticketId}')">‚úèÔ∏è Edit</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';

            if (filteredData.length > 500) {
                html += `<div style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 13px;">
                    Showing first 500 results. Use search to find specific tickets.
                </div>`;
            }

            container.innerHTML = html;
        }

        // ============ EDIT TICKET ============
        // INDEX CORRUPTION FIX: New function that uses Ticket_Number instead of array index
        function editTicketById(ticketNumber) {
            const index = ticketData.findIndex(t => t.Ticket_Number === ticketNumber);
            if (index === -1) {
                showToast('Ticket not found. Data may have been refreshed.', 'error');
                return;
            }
            editTicket(index);
        }
        
        // Legacy function kept for internal use (now protected against index corruption)
        function editTicket(index) {
            // Validate index is still valid
            if (index < 0 || index >= ticketData.length) {
                showToast('Invalid ticket. Please refresh and try again.', 'error');
                return;
            }
            
            const ticket = ticketData[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('editRowNum').value = ticket._rowNum || '';
            document.getElementById('editTicketNum').value = ticket.Ticket_Number;
            document.getElementById('editStatus').value = ticket.Status;
            document.getElementById('editName').value = ticket.Buyer_Name || '';
            document.getElementById('editPhone').value = ticket.Buyer_Phone || '';
            document.getElementById('editZone').value = ticket.Buyer_Zone || '';
            // MODIFIED: Only load existing Sold_By value, don't auto-fill if empty
            document.getElementById('editSoldBy').value = ticket.Sold_By || '';
            document.getElementById('editPayment').value = ticket.Payment_Status || '';
            document.getElementById('editNotes').value = ticket.Notes || '';
            
            // CONFLICT DETECTION: Store original timestamp to detect concurrent edits
            document.getElementById('editModal').dataset.originalTimestamp = ticket.Modified_Date || '';
            document.getElementById('editModal').dataset.originalModifier = ticket.Modified_By || '';

            document.getElementById('editModal').classList.add('active');
        }

        async function saveEdit() {
            const index = parseInt(document.getElementById('editIndex').value);
            const rowNum = parseInt(document.getElementById('editRowNum').value);
            const btn = document.getElementById('saveEditBtn');
            
            // CONFLICT DETECTION: Check if ticket was modified by someone else while editing
            const originalTimestamp = document.getElementById('editModal').dataset.originalTimestamp;
            const originalModifier = document.getElementById('editModal').dataset.originalModifier;
            const currentTimestamp = ticketData[index].Modified_Date || '';
            const currentModifier = ticketData[index].Modified_By || '';
            
            if (originalTimestamp && currentTimestamp && originalTimestamp !== currentTimestamp) {
                const warningMsg = `‚ö†Ô∏è WARNING: This ticket was modified by ${currentModifier || 'another user'} while you were editing.\n\nOriginal: ${originalModifier || 'None'} at ${new Date(originalTimestamp).toLocaleString()}\nCurrent: ${currentModifier} at ${new Date(currentTimestamp).toLocaleString()}\n\nDo you want to overwrite their changes?`;
                if (!confirm(warningMsg)) {
                    return; // User chose not to overwrite
                }
            }
            
            // Update local data
            ticketData[index].Status = document.getElementById('editStatus').value;
            ticketData[index].Buyer_Name = document.getElementById('editName').value;
            ticketData[index].Buyer_Phone = document.getElementById('editPhone').value;
            ticketData[index].Buyer_Zone = document.getElementById('editZone').value;
            ticketData[index].Sold_By = document.getElementById('editSoldBy').value;
            ticketData[index].Payment_Status = document.getElementById('editPayment').value;
            ticketData[index].Notes = document.getElementById('editNotes').value;
            // Track who made this change
            ticketData[index].Modified_By = currentStaffName;
            ticketData[index].Modified_Date = new Date().toISOString();

            if (ticketData[index].Status === 'Sold' && !ticketData[index].Payment_Date) {
                ticketData[index].Payment_Date = new Date().toISOString().split('T')[0];
            }

            // If connected to Google Sheets, update there too
            if (connectionVerified && staffAuthorized && rowNum) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Saving...';
                
                try {
                    const values = [
                        ticketData[index].Ticket_Number,
                        ticketData[index].Status,
                        ticketData[index].Sale_Type || '',
                        ticketData[index].Buyer_Name,
                        ticketData[index].Buyer_Phone,
                        ticketData[index].Buyer_Zone,
                        ticketData[index].Sold_By,
                        ticketData[index].Payment_Status,
                        ticketData[index].Payment_Date || '',
                        ticketData[index].Book_Number,
                        ticketData[index].Donated_To_Education || '',
                        ticketData[index].Notes
                    ];

                    // Google Account authentication happens automatically on server
                    const url = `${syncConfig.appsScriptUrl}?action=update&row=${rowNum}&values=${encodeURIComponent(JSON.stringify(values))}`;
                    
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast(`‚úÖ Saved by ${currentStaffName}!`, 'success');
                    } else if (result.code === 'STAFF_UNAUTHORIZED') {
                        showToast(`‚ö†Ô∏è "${currentStaffName}" is not in Staff sheet. Saved locally only.`, 'warning');
                        staffAuthorized = false;
                    } else {
                        showToast('Local saved, but Sheet update failed: ' + result.error, 'warning');
                    }
                } catch (error) {
                    console.error('Error updating sheet:', error);
                    showToast('Local saved, but Sheet update failed', 'warning');
                }
                
                btn.disabled = false;
                btn.innerHTML = 'üíæ Save Changes';
            } else if (connectionVerified && !staffAuthorized) {
                showToast(`‚ö†Ô∏è "${currentStaffName}" is not authorized. Saved locally only.`, 'warning');
            } else {
                showToast('Changes saved locally', 'success');
            }

            closeModal();
            updateStats();
            filterData();
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // ============ EXPORT CSV ============
        function exportCSV() {
            let csv = headers.join(',') + '\n';
            
            ticketData.forEach(ticket => {
                const row = headers.map(h => {
                    const val = ticket[h] || '';
                    return val.toString().includes(',') ? `"${val}"` : val;
                }).join(',');
                csv += row + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ceam_raffle_tickets_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('CSV exported successfully!', 'success');
        }

        // ============ GOOGLE SHEETS CONNECTION ============
        function showConnectModal() {
            document.getElementById('connectModal').classList.add('active');
            document.getElementById('connectingAsStaff').textContent = currentStaffName || '-';
            document.getElementById('connectionStatus').style.display = 'none';
            
            // Load saved config
            const savedUrl = localStorage.getItem('ceam_apps_script_url');
            
            if (savedUrl) document.getElementById('appsScriptUrl').value = savedUrl;
        }

        function closeConnectModal() {
            document.getElementById('connectModal').classList.remove('active');
        }

        // Connection function using Google Account authentication
        async function testAndConnect() {
            const url = document.getElementById('appsScriptUrl').value.trim();
            const statusDiv = document.getElementById('connectionStatus');
            const btn = document.getElementById('testConnectBtn');
            
            if (!url) {
                showConnectionStatus('error', '‚ùå Please enter Apps Script URL');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Connecting...';
            
            // Save config early
            syncConfig.appsScriptUrl = url;

            try {
                // Step 1: Test connection and get current user
                showConnectionStatus('info', 'üîÑ Step 1/2: Testing connection and verifying Google Account...');
                
                const pingUrl = `${url}?action=ping`;
                const pingResponse = await fetch(pingUrl);
                const pingResult = await pingResponse.json();

                if (!pingResult.success) {
                    if (pingResult.code === 'AUTH_REQUIRED') {
                        showConnectionStatus('error', `
                            ‚ùå <strong>Authentication Required</strong><br><br>
                            Please sign in with your Google account.<br><br>
                            <strong>To fix:</strong>
                            <ol class="connection-steps">
                                <li>Make sure you're signed in to Google</li>
                                <li>Refresh the page and try again</li>
                                <li>Check that the Apps Script is deployed with "Anyone" access</li>
                            </ol>
                        `);
                    } else {
                        showConnectionStatus('error', `‚ùå Connection failed: ${pingResult.error}`);
                    }
                    btn.disabled = false;
                    btn.innerHTML = 'üîó Test Connection & Connect';
                    return;
                }

                // Step 2: Get user info and validate authorization
                showConnectionStatus('info', 'üîÑ Step 2/2: Checking authorization...');
                
                const userUrl = `${url}?action=get_current_user`;
                const userResponse = await fetch(userUrl);
                const userResult = await userResponse.json();

                if (!userResult.success) {
                    if (userResult.code === 'UNAUTHORIZED') {
                        showConnectionStatus('error', `
                            ‚ùå <strong>Access Denied</strong><br><br>
                            Your Google account is not authorized.<br><br>
                            <strong>To fix:</strong>
                            <ol class="connection-steps">
                                <li>Open your Google Sheet</li>
                                <li>Go to the "Staff" tab</li>
                                <li>Add your email (${pingResult.user || 'your email'}) to Column A</li>
                                <li>Set your name in Column B</li>
                                <li>Set role (admin/staff) in Column C</li>
                                <li>Set Active to TRUE in Column D</li>
                                <li>Come back and try again</li>
                            </ol>
                        `);
                    } else {
                        showConnectionStatus('error', `‚ùå Authorization error: ${userResult.error}`);
                    }
                    btn.disabled = false;
                    btn.innerHTML = 'üîó Test Connection & Connect';
                    return;
                }

                // User is authorized - save info
                currentUserEmail = userResult.user.email;
                currentStaffName = userResult.user.name;
                currentUserRole = userResult.user.role;
                isLoggedIn = true;
                staffAuthorized = true; // If we got here, user is authorized

                // Step 3: Load data
                showConnectionStatus('info', 'üîÑ Loading ticket data...');
                
                const readUrl = `${url}?action=read`;
                const readResponse = await fetch(readUrl);
                const readResult = await readResponse.json();

                if (!readResult.success) {
                    showConnectionStatus('error', `‚ùå Failed to load data: ${readResult.error}`);
                    btn.disabled = false;
                    btn.innerHTML = 'üîó Test Connection & Connect';
                    return;
                }

                // Success!
                ticketData = readResult.data || [];
                connectionVerified = true;
                syncConfig.lastSync = new Date();
                
                // Save connection (no token needed)
                localStorage.setItem('ceam_apps_script_url', url);
                localStorage.setItem('ceam_admin_session', 'active');

                // Update UI
                updateStaffDisplay();
                updateReadOnlyIndicator();
                initializeUI();
                startAutoSync();
                
                updateSyncStatus('connected', `‚úÖ Connected as ${currentStaffName} (${currentUserRole})`);
                showToast(`Connected! ${ticketData.length} tickets loaded.`, 'success');
                
                closeConnectModal();

            } catch (error) {
                console.error('Connection error:', error);
                
                let errorMsg = error.message;
                if (errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError')) {
                    showConnectionStatus('error', `
                        ‚ùå <strong>Network Error</strong><br><br>
                        Could not connect to Google Sheets.<br><br>
                        <strong>Check:</strong>
                        <ol class="connection-steps">
                            <li>Your internet connection</li>
                            <li>The Apps Script URL is correct</li>
                            <li>The script is deployed with "Anyone" access</li>
                            <li>Try redeploying the Apps Script</li>
                        </ol>
                    `);
                } else {
                    showConnectionStatus('error', `‚ùå Error: ${errorMsg}`);
                }
            }
            
            btn.disabled = false;
            btn.innerHTML = 'üîó Test Connection & Connect';
        }

        function showConnectionStatus(type, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `connection-msg ${type}`;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
        }

        async function loadFromSheet() {
            if (!syncConfig.appsScriptUrl) return;
            
            // RACE CONDITION FIX: Prevent concurrent syncs
            if (isSyncing) {
                console.log('Sync already in progress, skipping...');
                return;
            }
            
            isSyncing = true;
            updateSyncStatus('syncing', 'üîÑ Syncing...');

            try {
                const url = `${syncConfig.appsScriptUrl}?action=read`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success && result.data) {
                    ticketData = result.data;
                    initializeUI();
                    syncConfig.lastSync = new Date();
                    
                    if (staffAuthorized) {
                        updateSyncStatus('connected', `‚úÖ Connected as ${currentStaffName}`);
                    } else {
                        updateSyncStatus('paused', `‚ö†Ô∏è Read Only - Add "${currentStaffName}" to Staff sheet`);
                    }
                    
                    document.getElementById('lastSyncTime').textContent = 
                        'Last sync: ' + syncConfig.lastSync.toLocaleTimeString();
                } else {
                    throw new Error(result.error || 'Failed to load data');
                }
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('error', '‚ùå Sync failed');
                showToast('Sync failed: ' + error.message, 'error');
            } finally {
                // Always release the lock, even if an error occurred
                isSyncing = false;
            }
        }

        function startAutoSync() {
            document.getElementById('syncStatusBar').style.display = 'flex';
            document.getElementById('autoSyncBtn').textContent = '‚è∏Ô∏è Pause';
            syncConfig.autoSync = true;

            if (syncIntervalId) clearInterval(syncIntervalId);

            syncIntervalId = setInterval(() => {
                if (syncConfig.autoSync) {
                    loadFromSheet();
                }
            }, syncConfig.syncInterval);
        }

        function toggleAutoSync() {
            syncConfig.autoSync = !syncConfig.autoSync;
            const btn = document.getElementById('autoSyncBtn');
            
            if (syncConfig.autoSync) {
                btn.textContent = '‚è∏Ô∏è Pause';
                if (staffAuthorized) {
                    updateSyncStatus('connected', `‚úÖ Connected as ${currentStaffName}`);
                } else {
                    updateSyncStatus('paused', `‚ö†Ô∏è Read Only`);
                }
            } else {
                btn.textContent = '‚ñ∂Ô∏è Resume';
                updateSyncStatus('paused', '‚è∏Ô∏è Auto-sync paused');
            }
        }

        function manualSync() {
            if (syncConfig.appsScriptUrl) {
                loadFromSheet();
            } else {
                showConnectModal();
            }
        }

        function disconnectSheet() {
            // Updated to provide option to reconnect with new URL after disconnect
            if (confirm('Disconnect from Google Sheets?\n\nYour local data will be kept.\n\nYou can reconnect with a different URL after disconnecting.')) {
                if (syncIntervalId) clearInterval(syncIntervalId);
                syncIntervalId = null;
                connectionVerified = false;
                staffAuthorized = false;
                isLoggedIn = false;
                syncConfig.appsScriptUrl = null;
                
                document.getElementById('syncStatusBar').style.display = 'none';
                localStorage.removeItem('ceam_apps_script_url');
                localStorage.removeItem('ceam_admin_session');
                localStorage.removeItem('ceam_session_time');
                
                // Show login overlay to allow reconnection with new URL
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('loginLoading').style.display = 'none';
                document.getElementById('authorizedMessage').style.display = 'none';
                document.getElementById('unauthorizedMessage').style.display = 'none';
                document.getElementById('connectionSetup').style.display = 'block';
                
                // Clear and focus URL input
                const urlInput = document.getElementById('setupAppsScriptUrl');
                if (urlInput) {
                    urlInput.value = '';
                    setTimeout(() => urlInput.focus(), 100);
                }
                
                showToast('Disconnected. Enter new URL to reconnect.', 'info');
            }
        }

        function updateSyncStatus(status, text) {
            const bar = document.getElementById('syncStatusBar');
            const icon = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');
            const badge = document.getElementById('securityBadge');
            
            bar.className = 'sync-status-bar';
            icon.className = 'sync-icon';
            
            switch (status) {
                case 'syncing':
                    bar.classList.add('syncing');
                    icon.classList.add('spinning');
                    icon.textContent = 'üîÑ';
                    break;
                case 'connected':
                    bar.classList.add('write-enabled');
                    icon.textContent = '‚úÖ';
                    badge.textContent = 'üîí Staff Verified';
                    break;
                case 'paused':
                    bar.classList.add('paused');
                    icon.textContent = '‚è∏Ô∏è';
                    break;
                case 'error':
                    bar.classList.add('error');
                    icon.textContent = '‚ùå';
                    break;
            }
            
            textEl.textContent = text;
        }

        // ============ EVENT LISTENERS ============
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('connectModal').addEventListener('click', function(e) {
            if (e.target === this) closeConnectModal();
        });

        document.getElementById('quickSellModal').addEventListener('click', function(e) {
            if (e.target === this) closeQuickSellModal();
        });

        document.getElementById('quickReserveModal').addEventListener('click', function(e) {
            if (e.target === this) closeQuickReserveModal();
        });

        document.getElementById('quickReportModal').addEventListener('click', function(e) {
            if (e.target === this) closeQuickReportModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeConnectModal();
                closeQuickSellModal();
                closeQuickReserveModal();
                closeQuickReportModal();
            }
        });

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', async function() {
            // Check for saved Google Sheets connection
            const savedUrl = localStorage.getItem('ceam_apps_script_url');
            
            if (savedUrl) {
                syncConfig.appsScriptUrl = savedUrl;
                connectionVerified = true;
            }
            
            // Add click handler for connect button (fallback if form submit doesn't work)
            const connectBtn = document.getElementById('connectButton');
            if (connectBtn) {
                connectBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('connectionSetupForm');
                    if (form) {
                        setupConnection({ preventDefault: () => {} });
                    }
                });
            }
            
            // Check for saved session first
            const hasSession = await checkSavedSession();
            
            if (!hasSession) {
                // No valid session - check Google Account access
                await initAccessCheck();
            } else {
                // Valid session exists - revalidate and reconnect
                setTimeout(() => {
                    revalidateStaffAndConnect();
                }, 500);
            }
        });

        // NEW: Re-validate staff when auto-reconnecting
        async function revalidateStaffAndConnect() {
            try {
                // Validate staff - Google Account identity used automatically
                const validateUrl = `${syncConfig.appsScriptUrl}?action=validate_staff`;
                const validateResponse = await fetch(validateUrl);
                const validateResult = await validateResponse.json();
                
                if (validateResult.success && validateResult.isAuthorized) {
                    staffAuthorized = true;
                } else {
                    staffAuthorized = false;
                }
                
                // Update read-only indicator
                updateReadOnlyIndicator();
                
                // Then load data
                await loadFromSheet();
                startAutoSync();
                
            } catch (error) {
                console.error('Auto-reconnect failed:', error);
                // Still try to load data
                loadFromSheet();
                startAutoSync();
            }
        }

        // ============ STAFF LIST FUNCTIONS (ADMIN ONLY) ============
        // Staff management is done in Google Sheets - this just displays the list
        
        async function showStaffManagementModal() {
            if (!isAdmin()) {
                showToast('‚ö†Ô∏è Admin access required', 'warning');
                return;
            }
            document.getElementById('staffManagementModal').classList.add('active');
            await refreshStaffList();
        }
        
        function closeStaffManagementModal() {
            document.getElementById('staffManagementModal').classList.remove('active');
        }
        
        async function refreshStaffList() {
            if (!hasConnection()) {
                document.getElementById('staffList').innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Not connected to Google Sheets.</p>';
                return;
            }
            
            try {
                const url = `${syncConfig.appsScriptUrl}?action=get_staff_list`;
                const response = await fetch(url);
                const result = await response.json();
                
                const listContainer = document.getElementById('staffList');
                
                if (!result.success || !result.staffList || result.staffList.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No staff members found in Staff sheet.</p>';
                    return;
                }
                
                let html = '';
                result.staffList.forEach(staff => {
                    const isCurrentUser = staff.email.toLowerCase() === currentUserEmail.toLowerCase();
                    const roleIcon = staff.role === 'admin' ? 'üëë' : 'üë§';
                    const roleBadge = staff.role === 'admin' ? 
                        '<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Admin</span>' :
                        '<span style="background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Staff</span>';
                    const activeBadge = staff.active ? 
                        '<span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Active</span>' :
                        '<span style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Inactive</span>';
                    
                    html += `
                        <div style="background: white; border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">${roleIcon}</span>
                                <strong>${escapeHtml(staff.name || staff.email.split('@')[0])}</strong>
                                ${roleBadge}
                                ${activeBadge}
                                ${isCurrentUser ? '<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 10px; font-size: 11px;">You</span>' : ''}
                            </div>
                            <div style="font-size: 11px; color: var(--text-muted);">
                                üìß ${escapeHtml(staff.email)}
                            </div>
                        </div>
                    `;
                });
                
                listContainer.innerHTML = html;
            } catch (error) {
                console.error('Error fetching staff list:', error);
                document.getElementById('staffList').innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">Error loading staff list.</p>';
            }
        }

        // Add shake animation for login error feedback
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>